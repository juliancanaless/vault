{% extends 'base.html' %}

{% block title %}{{ category_info.name }} | Spark | The Vault{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col">
    <!-- Top Bar with Back + Category -->
    <div class="px-6 pt-6 pb-2 flex items-center justify-between">
        <a href="{% url 'spark_index' %}" class="flex items-center gap-2 text-ink-500 hover:text-ink-900 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 19l-7-7 7-7"></path>
            </svg>
            <span class="text-sm font-medium">Back</span>
        </a>
        
        <span class="text-xs font-medium px-3 py-1 rounded-full border border-stone-200
            {% if category_info.color == 'rose' %}bg-rose-50 text-rose-600
            {% elif category_info.color == 'violet' %}bg-violet-50 text-violet-600
            {% elif category_info.color == 'amber' %}bg-amber-50 text-amber-700
            {% elif category_info.color == 'emerald' %}bg-emerald-50 text-emerald-600
            {% else %}bg-paper-100 text-ink-500{% endif %}
        ">
            {{ category_info.name }}
        </span>
    </div>
    
    <!-- Main Content -->
    <main class="flex-1 px-6 pb-8 flex flex-col">
        <div class="max-w-lg mx-auto w-full flex-1 flex flex-col">
            <!-- Card Container -->
            <div id="spark-card" class="flex-1 flex items-center justify-center py-8">
                {% include 'spark/partials/card.html' %}
            </div>
            
            <!-- Actions -->
            <div id="spark-actions" class="pb-4 animate-slide-up space-y-3" style="animation-delay: 0.2s;">
                {% include 'spark/partials/actions.html' %}
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Swipe gesture support with left/right detection
    let touchStartX = 0;
    let touchEndX = 0;
    
    function setupSwipeHandlers() {
        const cardContainer = document.getElementById('spark-card');
        if (!cardContainer) return;
        
        // Remove existing listeners if any (to avoid duplicates)
        cardContainer.removeEventListener('touchstart', handleTouchStart);
        cardContainer.removeEventListener('touchend', handleTouchEnd);
        
        cardContainer.addEventListener('touchstart', handleTouchStart, false);
        cardContainer.addEventListener('touchend', handleTouchEnd, false);
    }

    function setupArchiveHandlers() {
        const cardContainer = document.getElementById('spark-card');
        if (!cardContainer) return;

        const btn = cardContainer.querySelector('[data-archive-btn="true"][data-spark-id]');
        if (!btn) return;

        // avoid double-binding
        if (btn.dataset.bound === 'true') return;
        btn.dataset.bound = 'true';

        btn.addEventListener('click', function () {
            const sparkId = parseInt(btn.dataset.sparkId, 10);
            if (!Number.isFinite(sparkId)) return;
            toggleArchive(btn, sparkId);
        });
    }
    
    function handleTouchStart(e) {
        touchStartX = e.changedTouches[0].screenX;
    }
    
    function handleTouchEnd(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }
    
    function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;
        
        if (Math.abs(diff) > swipeThreshold) {
            const nextUrl = '{% url "spark_next" category %}{% if vibe %}?vibe={{ vibe }}{% endif %}';
            const prevUrl = '{% url "spark_prev" category %}{% if vibe %}?vibe={{ vibe }}{% endif %}';
            const hasHistory = !!document.querySelector('#spark-actions button[hx-get*="/prev/"]');
            
            if (diff > 0) {
                // Swipe left - go to next
                htmx.ajax('GET', nextUrl, {
                    target: '#spark-card',
                    swap: 'innerHTML'
                });
            } else if (hasHistory) {
                // Swipe right - go to previous (only if history exists)
                htmx.ajax('GET', prevUrl, {
                    target: '#spark-card',
                    swap: 'innerHTML'
                });
            }
        }
    }
    
    // Archive toggle function
    function toggleArchive(button, sparkId) {
        const currentlyArchived = (button && button.dataset && button.dataset.archived === 'true');
        const url = currentlyArchived 
            ? `/spark/${sparkId}/unarchive/`
            : `/spark/${sparkId}/archive/`;
        if (!button) return;
        
        // Disable button during request
        button.disabled = true;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update button appearance
                const newArchived = data.archived;
                const svg = button.querySelector('svg');
                button.dataset.archived = newArchived ? 'true' : 'false';
                if (newArchived) {
                    // Archived: animate card off-screen and auto-advance
                    if (svg) {
                        svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v7a2 2 0 01-2 2H6a2 2 0 01-2-2v-7m16 0H4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 11v6m0 0l-2-2m2 2l2-2"></path>';
                        svg.classList.remove('text-ink-400');
                        svg.classList.add('text-amber-600');
                        svg.setAttribute('fill', 'none');
                        svg.setAttribute('stroke', 'currentColor');
                    }
                    button.title = 'Unarchive';
                    button.setAttribute('aria-label', 'Unarchive');

                    const inner = document.getElementById('spark-card-inner');
                    if (inner) {
                        inner.style.transform = 'translateX(-120%) rotate(-2deg)';
                        inner.style.opacity = '0';
                    }

                    // Load next after a short delay so the animation is visible
                    setTimeout(() => {
                        htmx.ajax('GET', '{% url "spark_next" category %}{% if vibe %}?vibe={{ vibe }}{% endif %}', {
                            target: '#spark-card',
                            swap: 'innerHTML'
                        });
                    }, 180);
                } else {
                    // Unarchived
                    if (svg) {
                        svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v7a2 2 0 01-2 2H6a2 2 0 01-2-2v-7m16 0H4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 17v-6m0 0l-2 2m2-2l2 2"></path>';
                        svg.classList.remove('text-amber-600');
                        svg.classList.add('text-ink-400');
                        svg.setAttribute('fill', 'none');
                        svg.setAttribute('stroke', 'currentColor');
                    }
                    button.title = 'Archive';
                    button.setAttribute('aria-label', 'Archive');
                }
            }
        })
        .catch(error => {
            console.error('Error toggling archive:', error);
        })
        .finally(() => {
            button.disabled = false;
        });
    }
    
    // Helper to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Initialize handlers on page load
    setupSwipeHandlers();
    setupArchiveHandlers();
    
    // Re-initialize after HTMX swaps content
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'spark-card') {
            setupSwipeHandlers();
            setupArchiveHandlers();
        }
    });
</script>
{% endblock %}

